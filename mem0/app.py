# -*- coding: utf-8 -*-
"""
åŸºäº Mem0 å’Œ Chainlit çš„æœ¬åœ°è®°å¿†èŠå¤©æœºå™¨äºº
ä½¿ç”¨ Ollama æœ¬åœ°å¤§æ¨¡å‹å’Œæœ¬åœ°å‘é‡æ•°æ®åº“
"""

import os  # å¯¼å…¥ os æ¨¡å—ï¼Œç”¨äºæ“ä½œç³»ç»Ÿç›¸å…³åŠŸèƒ½
import requests  # å¯¼å…¥ requests åº“ï¼Œç”¨äºå‘é€ HTTP è¯·æ±‚
import chainlit as cl  # å¯¼å…¥ Chainlit åº“ï¼Œç®€å†™ä¸º cl
from config import init_mem0, OLLAMA_BASE_URL, CHAT_MODEL  # ä» config æ¨¡å—å¯¼å…¥é…ç½®

# ========================================
# ç¬¬ä¸€æ­¥ï¼šä»£ç†ç»•è¿‡è®¾ç½®ï¼ˆåœ¨æ–‡ä»¶æœ€å¼€å§‹ï¼‰
# ========================================
# ç¡®ä¿ localhost ä¸èµ°ä»£ç†ï¼ˆå·²åœ¨ config.py ä¸­è®¾ç½®ï¼Œè¿™é‡Œå†æ¬¡ç¡®è®¤ï¼‰
os.environ['NO_PROXY'] = 'localhost,127.0.0.1'
os.environ['no_proxy'] = 'localhost,127.0.0.1'

# ========================================
# å…¨å±€å˜é‡ï¼šMem0 è®°å¿†å®ä¾‹
# ========================================
memory = None  # åˆå§‹åŒ–ä¸º Noneï¼Œå°†åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆ›å»º


# ========================================
# è¾…åŠ©å‡½æ•°ï¼šè°ƒç”¨ Ollama ç”Ÿæˆå›å¤ï¼ˆæµå¼è¾“å‡ºç‰ˆæœ¬ï¼‰
# ========================================
# ã€ä¿®æ”¹ã€‘ï¼šå°†å®Œæ•´è¿”å›æ”¹ä¸ºæµå¼ç”Ÿæˆå™¨ï¼Œé€å—è¿”å›æ•°æ®
def call_ollama_stream(messages):
    """
    è°ƒç”¨ Ollama API ç”ŸæˆèŠå¤©å›å¤ï¼ˆæµå¼è¾“å‡ºï¼‰
    
    å‚æ•°:
        messages (list): æ¶ˆæ¯åˆ—è¡¨ï¼Œæ ¼å¼ä¸º [{"role": "user", "content": "..."}, ...]
    
    è¿”å›:
        generator: ç”Ÿæˆå™¨ï¼Œé€å—äº§å‡ºå›å¤æ–‡æœ¬ç‰‡æ®µ
    """
    # å¯¼å…¥ json æ¨¡å—ç”¨äºè§£ææµå¼å“åº”
    import json
    
    # æ„å»º Ollama API çš„å®Œæ•´ URLï¼ˆ/api/chat ç«¯ç‚¹ï¼‰
    url = f"{OLLAMA_BASE_URL}/api/chat"
    
    # æ„å»ºè¯·æ±‚ä½“ï¼ˆJSON æ ¼å¼ï¼‰
    # ã€ä¿®æ”¹ã€‘ï¼šå°† stream å‚æ•°è®¾ç½®ä¸º Trueï¼Œå¯ç”¨æµå¼è¾“å‡º
    payload = {
        "model": CHAT_MODEL,  # ä½¿ç”¨çš„æ¨¡å‹åç§°
        "messages": messages,  # ä¼ å…¥çš„æ¶ˆæ¯åˆ—è¡¨
        "stream": True  # ã€ä¿®æ”¹ã€‘ï¼šå¯ç”¨æµå¼è¾“å‡ºï¼Œé€å—è¿”å›æ•°æ®
    }
    
    try:
        # ã€ä¿®æ”¹ã€‘ï¼šä½¿ç”¨ stream=True å‚æ•°å‘é€è¯·æ±‚ï¼Œå¯ç”¨å“åº”æµ
        response = requests.post(url, json=payload, timeout=120, stream=True)
        response.raise_for_status()  # å¦‚æœå“åº”çŠ¶æ€ç ä¸æ˜¯ 2xxï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
        
        # ã€ä¿®æ”¹ã€‘ï¼šé€è¡Œè¯»å–æµå¼å“åº”
        # iter_lines() ä¼šé€è¡Œè¿”å›å“åº”å†…å®¹ï¼Œé€‚åˆå¤„ç†æµå¼æ•°æ®
        for line in response.iter_lines():
            if line:  # è·³è¿‡ç©ºè¡Œ
                # ã€ä¿®æ”¹ã€‘ï¼šè§£ææ¯ä¸€è¡Œçš„ JSON æ•°æ®
                try:
                    chunk = json.loads(line)  # å°† JSON å­—ç¬¦ä¸²è§£æä¸ºå­—å…¸
                    
                    # ã€ä¿®æ”¹ã€‘ï¼šæå–å½“å‰å—ä¸­çš„å†…å®¹ç‰‡æ®µ
                    # Ollama æµå¼å“åº”æ ¼å¼: {"message": {"content": "..."}, "done": false}
                    if 'message' in chunk and 'content' in chunk['message']:
                        content = chunk['message']['content']  # è·å–æ–‡æœ¬ç‰‡æ®µ
                        if content:  # å¦‚æœå†…å®¹ä¸ä¸ºç©º
                            yield content  # ã€ä¿®æ”¹ã€‘ï¼šé€šè¿‡ç”Ÿæˆå™¨è¿”å›æ–‡æœ¬ç‰‡æ®µ
                    
                    # ã€ä¿®æ”¹ã€‘ï¼šæ£€æŸ¥æ˜¯å¦å·²å®Œæˆ
                    if chunk.get('done', False):
                        break  # æµå¼è¾“å‡ºå®Œæˆï¼Œé€€å‡ºå¾ªç¯
                
                except json.JSONDecodeError:
                    # å¦‚æœæŸä¸€è¡Œè§£æå¤±è´¥ï¼Œè·³è¿‡è¯¥è¡Œ
                    continue
    
    except requests.exceptions.RequestException as e:
        # å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
        yield f"âŒ Ollama è°ƒç”¨å¤±è´¥: {str(e)}"


# ========================================
# Chainlit äº‹ä»¶ï¼šä¼šè¯å¼€å§‹
# ========================================
@cl.on_chat_start
async def on_chat_start():
    """
    å½“ç”¨æˆ·å¼€å§‹æ–°çš„èŠå¤©ä¼šè¯æ—¶è§¦å‘æ­¤å‡½æ•°
    ç”¨äºåˆå§‹åŒ– Mem0 å’Œå‘é€æ¬¢è¿æ¶ˆæ¯
    """
    global memory  # å£°æ˜ä½¿ç”¨å…¨å±€å˜é‡ memory
    
    # åˆå§‹åŒ– Mem0ï¼ˆå¦‚æœå°šæœªåˆå§‹åŒ–ï¼‰
    if memory is None:
        try:
            memory = init_mem0()  # è°ƒç”¨ config.py ä¸­çš„åˆå§‹åŒ–å‡½æ•°
            print("âœ… Mem0 å·²åˆå§‹åŒ–")
        except Exception as e:
            # å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œæ‰“å°é”™è¯¯å¹¶å‘é€è­¦å‘Šæ¶ˆæ¯
            print(f"âŒ Mem0 åˆå§‹åŒ–å¤±è´¥: {e}")
            await cl.Message(
                content=f"âš ï¸ è®°å¿†ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: {e}\n\nä½ ä»ç„¶å¯ä»¥èŠå¤©ï¼Œä½†ä¸ä¼šä¿å­˜è®°å¿†ã€‚"
            ).send()
            return
    
    # å‘é€æ¬¢è¿æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
    welcome_message = """
ğŸ‘‹ **ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„æœ¬åœ°è®°å¿†åŠ©æ‰‹**

æˆ‘ä½¿ç”¨ä»¥ä¸‹æŠ€æœ¯ä¸ºä½ æœåŠ¡ï¼š
- ğŸ¤– **å¤§æ¨¡å‹**: Ollama (gemma3:27b)
- ğŸ§  **è®°å¿†ç³»ç»Ÿ**: Mem0 (æœ¬åœ°å‘é‡æ•°æ®åº“)
- ğŸ¨ **ç•Œé¢**: Chainlit

æˆ‘ä¼šè®°ä½æˆ‘ä»¬çš„å¯¹è¯å†…å®¹ï¼Œä¸‹æ¬¡ä½ å¯ä»¥é—®æˆ‘ä¹‹å‰èŠè¿‡çš„äº‹æƒ…ï¼

è¯•ç€å‘Šè¯‰æˆ‘ä¸€äº›å…³äºä½ çš„ä¿¡æ¯å§ ğŸ˜Š
    """
    
    # å‘é€æ¬¢è¿æ¶ˆæ¯åˆ°ç•Œé¢
    await cl.Message(content=welcome_message).send()


# ========================================
# Chainlit äº‹ä»¶ï¼šæ¥æ”¶ç”¨æˆ·æ¶ˆæ¯
# ========================================
@cl.on_message
async def on_message(message: cl.Message):
    """
    å½“ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶è§¦å‘æ­¤å‡½æ•°
    å¤„ç†æ¶ˆæ¯ã€æ£€ç´¢è®°å¿†ã€è°ƒç”¨ Ollamaã€ä¿å­˜æ–°è®°å¿†
    
    å‚æ•°:
        message (cl.Message): Chainlit çš„æ¶ˆæ¯å¯¹è±¡ï¼ŒåŒ…å«ç”¨æˆ·è¾“å…¥
    """
    # è·å–ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬å†…å®¹
    user_input = message.content
    
    # ========================================
    # é‡è¦ï¼šä½¿ç”¨å›ºå®šçš„ user_id æ¥ç¡®ä¿è®°å¿†æŒä¹…åŒ–
    # ========================================
    # å¦‚æœä½¿ç”¨ cl.user_session.get("id")ï¼Œæ¯æ¬¡é‡å¯åº”ç”¨ ID éƒ½ä¼šå˜åŒ–
    # å¯¼è‡´æ— æ³•æ£€ç´¢åˆ°ä¹‹å‰çš„è®°å¿†ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨å›ºå®šçš„ç”¨æˆ· ID
    user_id = "default_user"  # å›ºå®šçš„ç”¨æˆ· IDï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹
    
    # å¯é€‰ï¼šå¦‚æœéœ€è¦å¤šç”¨æˆ·æ”¯æŒï¼Œå¯ä»¥ä½¿ç”¨å…¶ä»–æ–¹å¼è·å–ç”¨æˆ·æ ‡è¯†
    # ä¾‹å¦‚ï¼šuser_id = cl.user_session.get("user_email") or "default_user"
    
    print(f"ğŸ“ å½“å‰ç”¨æˆ· ID: {user_id}")  # è°ƒè¯•è¾“å‡º
    
    # ========================================
    # ç¬¬ä¸€æ­¥ï¼šä» Mem0 æ£€ç´¢ç›¸å…³è®°å¿†
    # ========================================
    relevant_memories = []  # åˆå§‹åŒ–ç›¸å…³è®°å¿†åˆ—è¡¨
    
    if memory is not None:  # å¦‚æœ Mem0 å·²åˆå§‹åŒ–
        try:
            # ä» Mem0 æœç´¢ä¸å½“å‰æ¶ˆæ¯ç›¸å…³çš„è®°å¿†
            # search() æ–¹æ³•ä¼šæ ¹æ®è¯­ä¹‰ç›¸ä¼¼åº¦è¿”å›ç›¸å…³è®°å¿†
            search_results = memory.search(
                query=user_input,  # æœç´¢æŸ¥è¯¢ï¼ˆç”¨æˆ·çš„å½“å‰æ¶ˆæ¯ï¼‰
                user_id=user_id,   # ç”¨æˆ· IDï¼ˆæ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„è®°å¿†ç©ºé—´ï¼‰
                limit=3            # æœ€å¤šè¿”å› 3 æ¡ç›¸å…³è®°å¿†
            )
            
            # æå–è®°å¿†å†…å®¹
            if search_results and 'results' in search_results:
                relevant_memories = [
                    mem['memory'] for mem in search_results['results']
                ]
                
                # å¦‚æœæ‰¾åˆ°äº†ç›¸å…³è®°å¿†ï¼Œæ‰“å°åˆ°æ§åˆ¶å°ï¼ˆè°ƒè¯•ç”¨ï¼‰
                if relevant_memories:
                    print(f"ğŸ§  æ£€ç´¢åˆ° {len(relevant_memories)} æ¡ç›¸å…³è®°å¿†:")
                    for i, mem in enumerate(relevant_memories, 1):
                        print(f"   [{i}] {mem}")
                else:
                    print("ğŸ§  æœªæ£€ç´¢åˆ°ç›¸å…³è®°å¿†ï¼ˆè¿™å¯èƒ½æ˜¯æ–°å¯¹è¯ï¼‰")
        
        except Exception as e:
            # å¦‚æœæ£€ç´¢å¤±è´¥ï¼Œæ‰“å°é”™è¯¯ï¼ˆä¸å½±å“èŠå¤©ç»§ç»­ï¼‰
            print(f"âš ï¸ è®°å¿†æ£€ç´¢å¤±è´¥: {e}")
    
    # ========================================
    # ç¬¬äºŒæ­¥ï¼šæ„å»ºå‘é€ç»™ Ollama çš„æ¶ˆæ¯
    # ========================================
    # å¦‚æœæœ‰ç›¸å…³è®°å¿†ï¼Œå°†å…¶æ·»åŠ åˆ°ç³»ç»Ÿæç¤ºä¸­
    system_message = "ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„åŠ©æ‰‹ã€‚"
    
    if relevant_memories:
        # å°†è®°å¿†æ•´åˆåˆ°ç³»ç»Ÿæ¶ˆæ¯ä¸­
        memory_context = "\n".join([f"- {mem}" for mem in relevant_memories])
        system_message += f"\n\n**ä½ å¯¹ç”¨æˆ·çš„è®°å¿†**:\n{memory_context}\n\nè¯·åœ¨å›ç­”æ—¶è‡ªç„¶åœ°è¿ç”¨è¿™äº›ä¿¡æ¯ã€‚"
    
    # æ„å»ºæ¶ˆæ¯åˆ—è¡¨ï¼ˆOllama çš„ chat API æ ¼å¼ï¼‰
    messages = [
        {"role": "system", "content": system_message},  # ç³»ç»Ÿæ¶ˆæ¯ï¼ˆåŒ…å«è®°å¿†ä¸Šä¸‹æ–‡ï¼‰
        {"role": "user", "content": user_input}         # ç”¨æˆ·æ¶ˆæ¯
    ]
    
    # ========================================
    # ç¬¬ä¸‰æ­¥ï¼šè°ƒç”¨ Ollama ç”Ÿæˆå›å¤ï¼ˆæµå¼è¾“å‡ºï¼‰
    # ========================================
    # ã€ä¿®æ”¹ã€‘ï¼šåˆ›å»ºä¸€ä¸ªç©ºæ¶ˆæ¯ï¼Œå¹¶é€šè¿‡æµå¼æ›´æ–°æ¥é€æ­¥æ˜¾ç¤ºå†…å®¹
    msg = cl.Message(content="")  # åˆ›å»ºç©ºæ¶ˆæ¯å¯¹è±¡
    await msg.send()  # å…ˆå‘é€ç©ºæ¶ˆæ¯åˆ°ç•Œé¢
    
    # ã€ä¿®æ”¹ã€‘ï¼šç”¨äºç´¯ç§¯å®Œæ•´çš„å›å¤æ–‡æœ¬ï¼ˆä¿å­˜åˆ°è®°å¿†æ—¶ä½¿ç”¨ï¼‰
    full_response = ""
    
    # ã€ä¿®æ”¹ã€‘ï¼šæ˜¾ç¤º"æ­£åœ¨ç”Ÿæˆ"çš„æç¤º
    async with cl.Step(name="ğŸ¤” æ­£åœ¨ç”Ÿæˆå›å¤..."):
        # ã€ä¿®æ”¹ã€‘ï¼šè°ƒç”¨æµå¼ç‰ˆæœ¬çš„ Ollama API
        for chunk in call_ollama_stream(messages):
            # ã€ä¿®æ”¹ã€‘ï¼šæ¯æ”¶åˆ°ä¸€ä¸ªæ–‡æœ¬ç‰‡æ®µï¼Œå°±ç´¯åŠ åˆ°å®Œæ•´å›å¤ä¸­
            full_response += chunk
            
            # ã€ä¿®æ”¹ã€‘ï¼šä½¿ç”¨ stream_token æ–¹æ³•é€å—æ›´æ–°æ¶ˆæ¯å†…å®¹
            # è¿™æ ·ç”¨æˆ·å¯ä»¥çœ‹åˆ°æ–‡å­—é€å­—å‡ºç°çš„æ•ˆæœï¼Œæå‡ä½“éªŒ
            await msg.stream_token(chunk)
    
    # ã€ä¿®æ”¹ã€‘ï¼šæµå¼è¾“å‡ºå®Œæˆåï¼Œæ›´æ–°æ¶ˆæ¯ä¸ºæœ€ç»ˆçŠ¶æ€
    await msg.update()
    
    # ========================================
    # ç¬¬å››æ­¥ï¼šå°†æ–°å¯¹è¯ä¿å­˜åˆ° Mem0
    # ========================================
    if memory is not None:
        try:
            # ã€ä¿®æ”¹ã€‘ï¼šä½¿ç”¨ç´¯ç§¯çš„å®Œæ•´å›å¤æ–‡æœ¬ä¿å­˜åˆ°è®°å¿†
            # å°†ç”¨æˆ·è¾“å…¥å’Œ AI å›å¤ä½œä¸ºå¯¹è¯ä¿å­˜åˆ° Mem0
            # add() æ–¹æ³•ä¼šè‡ªåŠ¨æå–å…³é”®ä¿¡æ¯å¹¶å­˜å‚¨ä¸ºè®°å¿†
            add_result = memory.add(
                messages=[
                    {"role": "user", "content": user_input},
                    {"role": "assistant", "content": full_response}  # ã€ä¿®æ”¹ã€‘ï¼šä½¿ç”¨å®Œæ•´å›å¤
                ],
                user_id=user_id  # å…³è”åˆ°å½“å‰ç”¨æˆ·
            )
            print(f"ğŸ’¾ å¯¹è¯å·²ä¿å­˜åˆ°è®°å¿†")
            print(f"   è¿”å›ç»“æœ: {add_result}")
        
        except Exception as e:
            # å¦‚æœä¿å­˜å¤±è´¥ï¼Œæ‰“å°é”™è¯¯ï¼ˆä¸å½±å“å›å¤æ˜¾ç¤ºï¼‰
            print(f"âš ï¸ è®°å¿†ä¿å­˜å¤±è´¥: {e}")


# ========================================
# ä¸»ç¨‹åºå…¥å£ï¼ˆå¯é€‰ï¼‰
# ========================================
if __name__ == "__main__":
    # æç¤ºï¼šä¸è¦ç›´æ¥è¿è¡Œæ­¤æ–‡ä»¶
    # åº”è¯¥ä½¿ç”¨ Chainlit å‘½ä»¤å¯åŠ¨ï¼šchainlit run app.py
    print("âš ï¸ è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨åº”ç”¨ï¼š")
    print("   chainlit run app.py -w")
